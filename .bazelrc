common --enable_runfiles

build --java_language_version=11
build --java_runtime_version=remotejdk_11

build --tool_java_language_version=11
build --tool_java_runtime_version=remotejdk_11

build --experimental_strict_java_deps=strict
build --explicit_java_test_deps

# Make sure we get something helpful when tests fail
test --verbose_failures
test --test_output=errors

# Required to get `protobuf` compiling. Note that MSVC requires a
# different flag than both macOS and Linux.

common --enable_platform_specific_config
common:linux --cxxopt=-std=c++17
common:linux --host_cxxopt=-std=c++17
common:macos --cxxopt=-std=c++17
common:macos --host_cxxopt=-std=c++17
common:windows --cxxopt=/std:c++17
common:windows --host_cxxopt=/std:c++17

# Enable protobuf MSVC support on Windows
build:windows --define=protobuf_allow_msvc=true

# rules_kotlin 2.x has a bug where the Kotlin compiler worker fails to
# resolve runfiles on Windows without this flag.
# https://github.com/bazelbuild/rules_kotlin/issues/1309
build:windows --legacy_external_runfiles

# Every JVM creates a temporary performance instrumentation file in
# /tmp/hsperfdata_$USERNAME/$PID. When we use sandboxing, we use PID
# namespaces, which means that the PIDs are virtualized and all
# running JVMs believe they are PID 2.
#
# This means that they all open/ftruncate/mmap the same file and that
# gives you SIGBUS eventually, because "It tries to read an address
# that no longer exists from an mmap'd file".
#
# https://github.com/bazelbuild/bazel/issues/3236#issuecomment-310776024

build --sandbox_tmpfs_path=/tmp

common --incompatible_enable_proto_toolchain_resolution
common --@protobuf//bazel/toolchains:prefer_prebuilt_protoc=true

# Exclude example workspaces from main build (they have their own MODULE.bazel)
# Run `bazel run @rules_bazel_integration_test//tools:update_deleted_packages` to update
build --deleted_packages=examples/android_kotlin_app,examples/android_kotlin_app/src,examples/android_local_test,examples/android_local_test/src/main,examples/android_local_test/src/test,examples/bzlmod,examples/bzlmod/java/src/com/github/rules_jvm_external/examples/bzlmod,examples/java-export,examples/java-export/src/main/java/com/github/bazelbuild/rulesjvmexternal/example/export,examples/java-export/src/main/java/com/github/bazelbuild/rulesjvmexternal/example/io,examples/java-export/src/main/proto,examples/kt_android_local_test,examples/kt_android_local_test/src/main,examples/kt_android_local_test/src/test,examples/kt_jvm_export,examples/kt_jvm_export/src/main/kotlin/com/github/bazelbuild/rulesjvmexternal/example/export,examples/pom_file_generation,examples/protobuf-java/src/main,examples/protobuf-java/src/test,examples/scala_akka,examples/simple,examples/spring_boot,examples/spring_boot/src/main/java/hello,examples/spring_boot/src/test/java/hello,tests/integration/bzlmod_lock_files,tests/integration/override_targets/module
query --deleted_packages=examples/android_kotlin_app,examples/android_kotlin_app/src,examples/android_local_test,examples/android_local_test/src/main,examples/android_local_test/src/test,examples/bzlmod,examples/bzlmod/java/src/com/github/rules_jvm_external/examples/bzlmod,examples/java-export,examples/java-export/src/main/java/com/github/bazelbuild/rulesjvmexternal/example/export,examples/java-export/src/main/java/com/github/bazelbuild/rulesjvmexternal/example/io,examples/java-export/src/main/proto,examples/kt_android_local_test,examples/kt_android_local_test/src/main,examples/kt_android_local_test/src/test,examples/kt_jvm_export,examples/kt_jvm_export/src/main/kotlin/com/github/bazelbuild/rulesjvmexternal/example/export,examples/pom_file_generation,examples/protobuf-java/src/main,examples/protobuf-java/src/test,examples/scala_akka,examples/simple,examples/spring_boot,examples/spring_boot/src/main/java/hello,examples/spring_boot/src/test/java/hello,tests/integration/bzlmod_lock_files,tests/integration/override_targets/module

# Allows the examples to extend the default bazelrc
try-import %workspace%/.bazelrc.example
