---
tasks:
  ubuntu2204:
    environment:
      # This tests custom cache locations.
      # https://github.com/bazelbuild/rules_jvm_external/pull/316
      COURSIER_CACHE: /tmp/custom_coursier_cache
      REPIN: 1
    shell_commands:
      - bazel run @regression_testing_coursier//:pin
      - bazel run @regression_testing_maven//:pin
      - bazel run @maven_install_in_custom_location//:pin
      - tests/bazel_run_tests.sh
    test_targets:
      - "--"
      - "//..."
  android_ubuntu2204:
    name: Android Tests
    platform: ubuntu2204
    test_flags:
      # TODO(https://github.com/bazelbuild/rules_jvm_external/issues/978):
      #   These tests are not compatible with Android platforms, so use the legacy mode
      - "--noincompatible_enable_android_toolchain_resolution"
    test_targets:
      - "--"
      - "//tests/integration/override_targets:override_targets"
  ubuntu2204_6_4_0:
    platform: ubuntu2204
    bazel: 6.4.0
    environment:
      REPIN: 1
    shell_commands:
      - bazel run @regression_testing_coursier//:pin
      - bazel run @regression_testing_maven//:pin
      - bazel run @maven_install_in_custom_location//:pin
      - tests/bazel_run_tests.sh
    test_targets:
      - "--"
      - "//..."
  ubuntu2204_7_4_1:
    platform: ubuntu2204
    bazel: 7.4.1
    environment:
      REPIN: 1
    shell_commands:
      - bazel run @regression_testing_coursier//:pin
      - bazel run @regression_testing_maven//:pin
      - bazel run @maven_install_in_custom_location//:pin
      - tests/bazel_run_tests.sh
    test_targets:
      - "--"
      - "//..."
  ubuntu2204_latest:
    platform: ubuntu2204
    # TODO: Revert to latest after fixing incompatibilities with Bazel 8.0.0
    bazel: 7.x
    environment:
      # This tests custom cache locations.
      # https://github.com/bazelbuild/rules_jvm_external/pull/316
      COURSIER_CACHE: /tmp/custom_coursier_cache
      REPIN: 1
    shell_commands:
      - bazel run @regression_testing_coursier//:pin
      - bazel run @regression_testing_maven//:pin
      - bazel run @maven_install_in_custom_location//:pin
      - tests/bazel_run_tests.sh
    test_targets:
      - "--"
      - "//..."
  macos:
    environment:
      # This tests custom cache locations.
      # https://github.com/bazelbuild/rules_jvm_external/pull/316
      COURSIER_CACHE: /tmp/custom_coursier_cache
      REPIN: 1
    shell_commands:
      - bazel run @regression_testing_coursier//:pin
      - bazel run @regression_testing_maven//:pin
      - bazel run @maven_install_in_custom_location//:pin
      - tests/bazel_run_tests.sh
    test_targets:
      - "//..."
      # manual tests

  windows_bashless:
    #This setup ensures that rules_jvm_external works without bash on Windows. 
    # note: this doesn't build targets under //tests/..., so its ok to use bash in the //tests area. Just don't use bash in the other areas.

    platform: windows
    environment:      
      BAZEL_SH: dummy #set BAZEL_SH to dummy so it won't get Bash. (Bazel will fallback to bash if BAZEL_SH is not set)
      MSYS2_ARG_CONV_EXCL: "*"

      # This tests custom cache locations.
      # https://github.com/bazelbuild/rules_jvm_external/pull/316
      COURSIER_CACHE: /tmp/custom_coursier_cache
      REPIN: 1
    batch_commands:
      - bazel run @regression_testing_coursier//:pin
      - bazel run @regression_testing_maven//:pin
      - bazel run @maven_install_in_custom_location//:pin
      - bash tests/bazel_run_tests.sh #This be successful without bash.
    test_targets:
      - "--"
      - "//..."
      - "-//tests/..." #//tests/... have bash. So test them in the other windows task.

  windows_tests_withbash:
    #This setup has bash, so we can test the bashful tests in //tests/...
    platform: windows
    environment:
      # This tests custom cache locations.
      # https://github.com/bazelbuild/rules_jvm_external/pull/316
      COURSIER_CACHE: /tmp/custom_coursier_cache
      REPIN: 1    
    test_targets:
      - "--"
      - "//..."
      # rules_kotlin is not tested / does not work on Windows.
      # https://github.com/bazelbuild/rules_kotlin/issues/179
      # https://github.com/bazelbuild/rules_kotlin/blob/master/.bazelci/presubmit.yml
      - "-//tests/unit/kotlin/..."
      # https://github.com/bazelbuild/rules_jvm_external/issues/586
      - "-//tests/unit/manifest_stamp:diff_signed_manifest_test"
